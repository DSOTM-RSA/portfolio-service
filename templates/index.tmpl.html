<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stock Portfolio Balancing</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<style>
    body {
        font-family: "Inter", sans-serif;
        font-optical-sizing: auto;
        font-weight: 300;
        font-style: normal;
    }
    button, input, select, textarea, label {
        font-family: inherit; 
        font-size: 14px;
        padding-bottom:4x ;
    }
    table {
        border-collapse: collapse;
        margin-top: 1em;
        width: 100%;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 4px 8px;      /* 1. Reduced vertical padding */
        text-align: left;
        font-size: 14px;
        vertical-align: middle;/* 2. This is the key for vertical alignment */
    }
    th {
        background-color: #f2f2f2;
    }
    
    /* 3. New styles for the purchase price input */
    .price-input-wrapper {
        display: flex;
        align-items: center; /* This vertically aligns the 'â‚¬' and the input box */
    }
    .price-input-wrapper span {
        padding-right: 4px; /* Adds a small space */
    }
    
    /* A little extra styling for inputs and buttons inside the table */
    td input {
        border: 1px solid #ccc;
        border-radius: 3px;
        padding: 4px;
    }
    td button {
        border: 1px solid #999;
        border-radius: 3px;
        background-color: #f0f0f0;
        cursor: pointer;
        padding: 4px 8px;
    }
    td button:hover {
        background-color: #e0e0e0;
    }
    
    .actions-wrapper {
        display: flex;
        gap: 5px;
    }
    form {
        margin: 0; /* Removes extra space from forms */
    }
    .below-ma {
        background-color: #e6ffed;
    }
    .controls {
        display: flex;       /* This is the key: arranges children horizontally */
        align-items: center; /* Vertically aligns the buttons nicely */
        gap: 1em;            /* This creates a 1em space between the buttons */
        margin-top: 1em;
    }
</style>
</head>
<body>
    <nav style="display: flex; justify-content: space-between;">
        <a href="/logs">View Investment Logs â†’</a>
        <form action="/logout" method="POST">
            <button type="submit">Logout</button>
        </form>
    </nav>
    <h1>Stock Portfolio Balancing ðŸ“ˆ</h1>

    <h3 style="margin-top: 2em;">Find a Stock</h3>
    <form action="/search" method="GET">
        <input type="text" name="query" placeholder="Ticker or Company Name" required>
        <button type="submit">Search</button>
    </form>

{{ if .searchResults }}
    <h3>Search Results:</h3>
    <table>
        <tr>
            <th>Symbol</th>
            <th>Name</th>
            <th>Exchange</th>
        </tr>
        {{ range .searchResults }}
        <tr>
            <td>{{ .Symbol }}</td>
            <td>{{ .Name }}</td>
            <td>{{ .Exchange }}</td>
        </tr>
        {{ end }}
    </table>
{{ end }}

    <h3>Budget for Next Cycle</h3>
        <form action="/update-budget" method="POST" class="controls">
            <span>â‚¬</span>
            <input type="number" step="any" name="amount" value="{{ printf "%.2f" .currentBudget }}" style="width: 100px;">
            <button type="submit">Update Budget</button>
        </form>
        
    <h3 style="margin-top: 2em;">Analysis</h3>
    <div class="controls">
        <form action="/analyze" method="POST" onsubmit="showToast('Analyzing portfolio, please wait...', 'linear-gradient(to right, #00b09b, #96c93d)')">
            <button type="submit">1. Analyze Prices & 200-Day MA</button>
        </form>
        <form action="/allocate" method="POST" onsubmit="showToast('Allocating funds and logging strategies...', 'linear-gradient(to right, #ff5f6d, #ffc371)')">
            <button type="submit">2. Allocate Funds & Log Strategies</button>
        </form>
    </div>

    <h3>Current Holdings</h3>
    <table>
        <tr>
            <th>Ticker</th>
            <th>Name</th>
            <th>Quantity</th>
            <th>Purchase Price</th>
            <th>Current Price</th>
            <th>MA-200</th>
            <th>EMA-112</th>
            <th>Recommendation</th>
            <th>Actions</th>
        </tr>

        {{ range .stocks }}
        <tr class="{{ if .IsBelowMA }}below-ma{{ end }}">
            <td>{{ .Ticker }}</td>
            <td>{{ .Name }}</td>

            <form action="/update" method="POST" id="form-{{.Ticker}}"></form>
            
            <td>
                <input type="number" name="quantity" step="any" value="{{ .Quantity }}" style="width: 70px;" form="form-{{.Ticker}}">
            </td>
            <td>
                <div class="price-input-wrapper">
                    <span>â‚¬</span>
                    <input type="number" step="any" name="price" value="{{ printf "%.2f" .Price }}" style="width: 80px;" form="form-{{.Ticker}}">
                </div>
            </td>
            <td>{{ if .CurrentPrice }}â‚¬{{ printf "%.2f" .CurrentPrice }}{{ end }}</td>
            <td>{{ if .MA200 }}â‚¬{{ printf "%.2f" .MA200 }}{{ end }}</td>
            <td>{{ if .EMATrend }}{{ printf "%.4f" .EMATrend }}{{ end }}</td>
            <td>{{ .Recommendation }}</td>
            <td>
                <div class="actions-wrapper">
                    <button type="submit" name="ticker" value="{{.Ticker}}" form="form-{{.Ticker}}">Save</button>
                    <form action="/delete" method="POST" onsubmit="return confirm('Are you sure you want to delete {{.Ticker}}?');">
                        <input type="hidden" name="ticker" value="{{ .Ticker }}">
                        <button type="submit">Delete</button>
                    </form>
                </div>
            </td>
        </tr>
        {{ end }}
    </table>

    <h3 style="margin-top: 2em;">Add New Stock</h3>
    <form action="/add-stock" method="POST">
        <label>Ticker:</label>
        <input type="text" name="ticker" required>
        <label>Name:</label>
        <input type="text" name="name" required>
        <label>Quantity:</label>
        <input type="number" step="0.1"  name="quantity" required>
        <label>Purchase Price:</label>
        <input type="number" step="0.01" name="price" required>
        <button type="submit">Add Stock</button>
    </form>

    <script>
        function showToast(text, background) {
            Toastify({
                text: text,
                duration: -1, // Stays until the page reloads
                newWindow: true,
                close: false,
                gravity: "top",
                position: "right",
                stopOnFocus: true,
                style: {
                    background: background,
                },
            }).showToast();
        }

        // This runs when the page loads to check for a success message
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');

            if (status === 'analyzed') {
                Toastify({ text: "âœ… Analysis Complete!", duration: 3000, gravity: "top", position: "right" }).showToast();
            } else if (status === 'allocated') {
                Toastify({ text: "âœ… Funds Allocated & Logged!", duration:3000, gravity: "top", position: "right" }).showToast();
            }
        });
    </script>

</body>
</html>